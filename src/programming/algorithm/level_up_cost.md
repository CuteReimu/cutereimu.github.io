---
title: 动态规划计算累计概率问题
order: 10
category: 编程日记
icon: arrow-up-9-1
tags:
  - 算法
  - 动态规划
  - Python
date: 2025-12-05
---

某游戏中有一个升级系统，每次尝试升级时，会有一定的概率成功或失败，成功后则等级+1，失败则等级不变。升级时会消耗一定的资源，升级成功的概率和资源的消耗量都仅与当前等级有关。具体规则如下：

| 当前等级   | 成功率 | 升级消耗 |
|--------|-----|------|
| 0 ~ 2  | 35% | 10   |
| 3 ~ 6  | 20% | 20   |
| 7      | 15% | 30   |
| 8      | 10% | 30   |
| &ge; 9 | 5%  | 50   |

一开始等级为0，玩家有且仅有20次升级尝试的机会，无论成功或失败都算作一次尝试。

问题：计算玩家用完20次升级尝试后，总消耗的资源的概率分布。

<!-- more -->

---

为了计算总消耗的分布，我们采用动态规划方法。

我们首先可以用数学方法可以得到以下两个简单的推论：
- 因为9级之后的消耗是固定的50，题目只是求解消耗，因此我们可以干脆认为9级必定失败，就不需要后续等级的状态了
- 20次最多消耗720，大于720的状态是不会达到的，所以无意义

定义状态 $dp[n][\ell][s]$ 表示经过 $n$ 次升级后，等级为 $\ell$，总消耗为 $s$ 的概率。其中：
- $n = 0,1,\dots,20$（升级次数）
- $\ell = 0,1,\dots,9$（等级）
- $s$ 为总消耗，是 10 的倍数，范围从 0 到 720

初始状态：$dp[0][0][0] = 1$。

状态转移：对于每个状态 $dp[n][\ell][s]$，根据当前等级 $\ell$ 查表得到消耗 $c(\ell)$ 和升级成功概率 $p(\ell)$。

- 如果 $\ell < 9$
  - 以概率 $p(\ell)$ 升级成功，转移到 $dp[n+1][\ell+1][s + c(\ell)]$。
  - 以概率 $1 - p(\ell)$ 升级失败，转移到 $dp[n+1][\ell][s + c(\ell)]$。
- 当 $\ell >= 9$ 时，消耗固定为 $c(9) = 50$。

最终，总消耗为 $s$ 的概率为 $\displaystyle\sum_{\ell=0}^{9} dp[20][\ell][s]$。

代码实现如下：

```python :no-collapsed-lines
# 概率和消耗表
prob_main = [0.35]*3 + [0.2]*4 + [0.15, 0.1, 0.0]
cost = [10]*3 + [20]*4 + [30, 30, 50]

# 动态规划
dp = [[[0]*73 for _ in range(10)] for _ in range(21)]  # s/10 作为索引，最大72
dp[0][0][0] = 1.0

for n in range(20):
    for l in range(10):
        p = prob_main[l]
        c = cost[l] // 10  # 除以10作为索引步长
        for s_idx in range(73):
            prob = dp[n][l][s_idx]
            if prob == 0:
                continue
            # 升级失败
            dp[n+1][l][s_idx+c] += prob * (1-p)
            # 升级成功
            if l < 10:
                dp[n+1][l+1][s_idx+c] += prob * p

# 收集结果
dist = {}
for s_idx in range(73):
    total_prob = sum(dp[20][l][s_idx] for l in range(10))
    if total_prob > 0:
        dist[s_idx*10] = total_prob

# 按消耗排序输出
for s in sorted(dist.keys()):
    print(f"{s}: {dist[s]:.6f}")
```

最终可以得到总消耗的概率分布，如下图所示：

::: chartjs

```json
{
  "type": "bar",
  "data": {
    "labels": [
      "200",
      "210",
      "220",
      "230",
      "240",
      "250",
      "260",
      "270",
      "280",
      "290",
      "300",
      "310",
      "320",
      "330",
      "340",
      "350",
      "360",
      "370",
      "380",
      "390",
      "400",
      "410",
      "420",
      "430",
      "440",
      "450",
      "460",
      "470",
      "480",
      "490",
      "500",
      "510",
      "520",
      "530",
      "540",
      "550",
      "560",
      "570",
      "580",
      "590",
      "600",
      "610",
      "620",
      "630",
      "640",
      "650",
      "660",
      "670",
      "680",
      "690",
      "700",
      "720"
    ],
    "datasets": [
      {
        "label": "概率分布（‰）",
        "data": [
          1.6956391220756921,
          0.6660537382759878,
          0.9108427190098979,
          1.2364380801039339,
          1.6644358770629877,
          2.21569703954625,
          2.9103655094504806,
          3.759992227167592,
          4.764964459642544,
          5.901369140749157,
          7.115607445804771,
          8.307155201817364,
          9.325696884500045,
          9.960940369954145,
          9.96504253338648,
          9.089871686124754,
          7.204739772407863,
          4.495895843642834,
          1.864791308484083,
          1.5808563475642683,
          1.3059798908200848,
          1.0471562019582266,
          0.8167739719690246,
          0.6141936378966437,
          0.44899318770983965,
          0.3157940124093763,
          0.21715044112879997,
          0.14509255968496923,
          0.0996046580297862,
          0.06865420181086501,
          0.05270175098427022,
          0.04205585856842835,
          0.03579310915215238,
          0.02991793603907299,
          0.02573898697758886,
          0.020632425398103747,
          0.0173077285801103,
          0.014055584026154996,
          0.011273171654907418,
          0.008674465369499996,
          0.007284230448173434,
          0.005120573597999999,
          0.004109387227968749,
          0.0030604518,
          0.002176419249375,
          0.0013986167999999993,
          0.0012856711874999994,
          0.0005762399999999996,
          0.0004370677499999997,
          0.00032927999999999983,
          0.00018007499999999992,
          0.00010289999999999994
        ],
        "borderWidth": 1,
        "categoryPercentage": 1.0,
        "barPercentage": 1.0
      }
    ]
  },
  "options": {
    "scales": {
      "x": {
        "title": {
          "display": true,
          "text": "总消耗"
        },
        "ticks": {
          "maxRotation": 0
        },
        "grid": {
          "display": false
        }
      },
      "y": {
        "title": {
          "display": true,
          "text": "概率（％）"
        },
        "beginAtZero": true,
        "border": {
          "display": false
        }
      }
    },
    "plugins": {
      "legend": {
        "display": false
      }
    }
  }
}
```
